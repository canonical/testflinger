type: charm
name: testflinger-k8s
title: Testflinger Server
summary: Juju K8s charm for Testflinger server
description: |
  Testflinger is a microservice that provides an API to request tests
  and place the tests on a queue which can be serviced by any agent
  capable of handling the test.

links:
  source: [https://github.com/canonical/testflinger]
  issues: [https://github.com/canonical/testflinger/issues]
  website: [https://canonical-testflinger.readthedocs-hosted.com/en/latest/]

containers:
  testflinger:
    resource: testflinger-image

resources:
  testflinger-image:
    type: oci-image
    description: OCI image for the 'testflinger' container
    upstream-source: ghcr.io/canonical/testflinger:main

requires:
  mongodb_client:
    interface: mongodb_client
    limit: 1
  nginx-route:
    interface: nginx-route
    limit: 1
  traefik-route:
    interface: traefik_route
    limit: 1

provides:
  metrics-endpoint:
    interface: prometheus_scrape
    optional: true
    description: |
      Forwards the metrics to a Prometheus scrape endpoint.
  grafana-dashboard:
    interface: grafana_dashboard
    optional: true
    description: |
      Forwards the built-in Grafana dashboard(s) for monitoring metrics.

charm-libs:
  - lib: data_platform_libs.data_interfaces
    version: "0"
  - lib: nginx_ingress_integrator.nginx_route
    version: "0"
  - lib: prometheus_k8s.prometheus_scrape
    version: "0"
  - lib: observability_libs.juju_topology
    version: "0"
  - lib: grafana_k8s.grafana_dashboard
    version: "0"
  - lib: traefik_k8s.traefik_route
    version: "0"

base: ubuntu@22.04
platforms:
  amd64:

actions:
  set-admin-password:
    description: Update or set a password for admin user
    params:
      password:
        type: string
        description: The password to set to admin user.

config:
  options:
    external_hostname:
      type: string
      default: testflinger.local
      description: |
        The external hostname for accessing the Testflinger server
        This configuration is used to configure the nginx or traefik route.
        While it is valid for traefik route, the preferred approach is to set
        the external_hostname in the traefik application configuration instead.
    keepalive:
      type: int
      default: 10
      description: Number of seconds to wait for keepalive connections
    max_pool_size:
      type: int
      default: 100
      description: Maximum number of concurrent connections to the database
    jwt_signing_key:
      type: string
      default: ""
      description: The secret key used for signing authorization tokens
    testflinger_secrets_master_key:
      type: string
      default: ""
      description: The master key used for encrypting secrets data keys
    http_proxy:
      type: string
      default: ""
      description: HTTP proxy for accessing external HTTP resources
    https_proxy:
      type: string
      default: ""
      description: HTTPS proxy for accessing external HTTPS resources
    no_proxy:
      type: string
      default: "localhost,127.0.0.1,::1"
      description: Resources that we should be able to access bypassing proxy

parts:
  charm:
    plugin: charm
    source: .
    build-packages: [pkg-config, libffi-dev, libssl-dev, build-essential]
    build-snaps: [rustup]
    override-build: |
      # Upgrade setuptools to avoid vendoring vulnerable versions (CVEs fixed in 70.0+)
      python3 -m pip install --upgrade pip setuptools
      
      # pydantic requires a higher version of rustc than what is in the archive
      # for 22.04
      # Install rustc and cargo using rustup instead of the Ubuntu archive
      rustup set profile minimal
      rustup default 1.92.0  # renovate: charmcraft-rust-latest

      craftctl default
