[tox]
env_list =
    lock
    lint
    unit
    schema
no_package = true
requires =
    tox-uv>=1.25.0

[testenv]
runner = uv-venv-lock-runner
dependency_groups = 
    dev

[testenv:lock]
description = Check lock file
commands = 
    uv lock --check

[testenv:format]
description = Apply coding style standards to code
commands =
    djlint --reformat src
    ruff format
    ruff check --fix

[testenv:lint]
description = Check code against coding style standards
dependency_groups =
    dev
    charm
set_env =
    PYTHONPATH = {tox_root}/charm/src:{tox_root}/charm/lib
commands =
    djlint --check src
    djlint --lint src
    ruff format --check
    ruff check

[testenv:unit]
description = Run unit tests
commands =
    pytest \
        --ignore app.py \
        --cov=src \
        --cov-branch \
        --cov-report=term \
        --cov-report=xml:coverage.xml \
        {posargs:tests}

[testenv:charm-unit]
description = Run charm unit tests
dependency_groups =
    dev
    charm
set_env =
    PYTHONPATH = {toxinidir}/charm/src:{toxinidir}/charm/lib
commands =
    pytest -v \
           -s \
           --tb native \
           --log-cli-level=INFO \
           {posargs} \
           --cov=charm/src charm/tests/unit

[testenv:charm-integration]
description = Run charm integration tests
change_dir = {toxinidir}/charm
dependency_groups =
    dev
    charm
set_env =
    PYTHONPATH = {toxinidir}/charm/src:{toxinidir}/charm/lib
commands =
    pytest -v \
           -s \
           --tb native \
           --log-cli-level=INFO \
           {posargs} \
           tests/integration

[testenv:schema]
description = Generate server OpenAPI schema
commands =
    python scripts/generate_openapi_schema.py --output schemas/openapi.json

[testenv:check-schema]
description = Check server OpenAPI schema is up-to-date
commands =
    python scripts/generate_openapi_schema.py --diff schemas/openapi.json
