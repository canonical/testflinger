name: server
services:
  mongo:
    container_name: mongo
    image: mongo:5
    environment:
      MONGO_INITDB_ROOT_PASSWORD: testflinger
      MONGO_INITDB_ROOT_USERNAME: testflinger
    ports:
      - 27017:27017
  testflinger:
    container_name: testflinger-server
    build:
      context: .
      additional_contexts:
        common: ../common
    environment:
      JWT_SIGNING_KEY: my_secret_key
      MONGODB_AUTH_SOURCE: admin
      MONGODB_DATABASE: testflinger_db
      MONGODB_HOST: mongo
      MONGODB_PASSWORD: testflinger
      MONGODB_USERNAME: testflinger
      MONGO_MASTER_KEY: +HQgnGBgPmmvoYB82nGbKERUp15bZOrNyDxHb3mMfx8+jrn4KbPBGOh7GRWDSGrSa1qOq/ibTThG+b7JGDRo0hgLinpFz5uz+8TWJdXbTGb24Qw+tuyH7kcPRPBMU3br
      # TESTFLINGER_VAULT_TOKEN: myroot
      # TESTFLINGER_VAULT_URL: http://vault:8200
    command: --reload
    ports:
      - 5000:5000
    depends_on:
      - mongo
    restart: always
  vault:
    container_name: vault
    image: hashicorp/vault:latest
    environment:
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_DEV_ROOT_TOKEN_ID: myroot
    command: ["vault", "server", "-dev"]
    cap_add:
      - IPC_LOCK
    ports:
      - 8200:8200
